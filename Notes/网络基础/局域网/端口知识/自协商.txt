Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2022-08-10T19:20:17+08:00

====== 自协商 ======
Created 星期三 10 八月 2022
自动协商模式是端口根据另一端设备的连接速度和双工模式，自动把它的速度调节到最高的公共水平，即线路两端能具有的最快速度和双工模式。
自协商功能完全由物理层芯片设计实现，因此并不使用专用数据包或带来任何高层协议开销。

自协商是通过一种叫快速连接脉冲（Fast Link Pulse）的信号实现的。自协商双方通过FLP来交换数据。则都会接收到对方的FLP，并且把FLP中的信息解码出来。得到对方的连接能力。并且把对端的自协商能力值记录在自协商对端能力寄存器中（Auto-Negotiation Link Partner Ability Register ， PHY标准寄存器地址5 ）。同时把状态寄存器（PHY标准寄存器地址1）的自协商完成bit（bit5）置成1。

为了保证在对端不能支持自协商的情况下也能连接，引入了被称为并行检测（Parallel Detection）的机制。在一端打开自协商，另一端关闭自协商的情况下，连接的建立就依靠并行检测功能实现。
并行检测机制是这样的：在具有自协商能力的设备端口上，如果接收不到FLP，则检测是否有10M链路的特征信号或100M链路的特征信号。
	   1） 如果设备是10M设备，不支持自协商，则在链路上发送普通连接脉冲（Normal Link Pulse）简称NLP。NLP仅仅表示设备在位，不包含其它的额外信息。
	   2） 如果是100M设备，不支持自协商，则在没有数据的情况下，在链路上一直发送4B/5B编码的Idle符号。
并行检测机制如果检测到NLP，则知道对方支持10M速率；如果检测到4B/5B编码的Idle符号，则知道对方支持100M速率。但是对方是否支持全双工、是否支持流控帧这些信息是无法得到的。因此在这种情况下，认为对方只支持半双工，不支持全双工，且不支持流控帧。
	   基于以上原理，在对端不打开自协商时，打开自协商的一方只能协商成半双工模式。
通过并行检测建立连接后，PHY的状态寄存器（PHY标准寄存器地址1）的自协商完成bit（bit5）依然要置位成1，尽管链路上并非使用了真正的自协商操作。同时规定在自协商完成bit为1的情况下，本地自协商能力寄存器（PHY标准寄存器地址4）和对端自协商能力寄存器（PHY标准寄存器地址5）是有意义的。所以，要把寄存器5中的数据更新。如果建立的连接为10M，则寄存器5的10M能力bit（bit5）置1，其它bit置0，表示对端只能支持10M半双工；如果建立的连接为100M，则寄存器5的100M能力bit（bit7）置1，其它bit置0，表示对端只能支持100M半双工。
————————————————
1．以太网口的两端工作模式（10M半双工、10M全双工、100M半双工、100M全双工、自协商）必须设置一致。

2．如果一端是固定模式(无论是10M、100M)，另外一端是自协商模式，即便能够协商成功，自协商的那一端也将只能工作在半双工模式。

3．如果一端工作在全双工模式，另外一端工作在半双工模式(包括自协商出来的半双工，也一样处理)，Ping是没有问题的，流量小的时候也没有任何问题，流量达到约15%以上时，就会出现冲突、错包，最终影响了工作性能！

4．对于两端工作模式都是自协商，最后协商成的结果是“两端都支持的工作模式中优先级最高的那一类”。

5． 如果A端自协商，B端设置为100M全双工，A协商为100M半双工后，再强制将B改为10M全双工，A端也会马上向下协商到10M半双工；如果A端自协商，B端设置为10M全双工，A协商为10M半双工后，再强制将B改为100M全双工，会出现协商不成功，连接不上！这个时候，如果插拔一下网线，又会重新协商在100M半双工
————————————————
